# 🛡️ 开发规范 - 避免频繁出错

## ❌ 常见错误原因

### 1. 路由未注册
**症状**: 404错误，接口不存在
**原因**: 添加新路由后忘记在 `server.js` 中注册
**解决**: 每次添加路由文件后，立即在 `server.js` 中注册

### 2. 脚本加载失败
**症状**: `ReferenceError: XXX is not defined`
**原因**: 外部脚本文件路径错误或未部署
**解决**: 使用内联脚本，避免外部文件依赖

### 3. Token验证失败
**症状**: 401/404错误，用户不存在
**原因**: Token格式错误或用户ID不匹配
**解决**: 统一使用 `api.setToken()` 方法

### 4. 数据库查询错误
**症状**: 500错误，查询失败
**原因**: 使用 `single()` 而不是 `maybeSingle()`
**解决**: 查询可能不存在的数据时，使用 `maybeSingle()`

---

## ✅ 开发检查清单

### 添加新功能前
- [ ] 检查是否需要新路由
- [ ] 检查是否需要新数据库表
- [ ] 检查是否需要新环境变量

### 添加新路由后
- [ ] 在 `server.js` 中注册路由
- [ ] 测试路由是否可访问
- [ ] 检查CORS配置是否允许该路由

### 修改前端后
- [ ] 检查所有脚本路径是否正确
- [ ] 使用内联脚本避免外部依赖
- [ ] 测试所有功能是否正常

### 部署前
- [ ] 检查所有环境变量是否设置
- [ ] 检查数据库表是否创建
- [ ] 检查路由是否全部注册
- [ ] 本地测试所有功能

---

## 🚀 标准开发流程

### 1. 后端开发
```bash
# 1. 创建路由文件
touch routes/new-feature.js

# 2. 立即在 server.js 中注册
# app.use('/api/new-feature', newFeatureRoutes);

# 3. 测试
npm start
curl http://localhost:3000/api/new-feature/test
```

### 2. 前端开发
```javascript
// 1. 使用内联配置，避免外部文件
<script>
  const CONFIG = { /* ... */ };
  class API { /* ... */ }
  const api = new API();
</script>

// 2. 测试
console.log('API:', api);
```

### 3. 数据库操作
```javascript
// ✅ 正确：使用 maybeSingle()
const { data, error } = await supabase
  .from('users')
  .select('*')
  .eq('id', userId)
  .maybeSingle(); // 不会在找不到数据时抛出错误

// ❌ 错误：使用 single()
const { data, error } = await supabase
  .from('users')
  .select('*')
  .eq('id', userId)
  .single(); // 找不到数据时会抛出错误
```

---

## 🔧 快速修复指南

### 404错误
1. 检查路由是否在 `server.js` 中注册
2. 检查路由路径是否正确
3. 检查服务是否正在运行

### 401错误
1. 检查Token是否正确传递
2. 检查Token是否过期
3. 检查用户是否存在

### 500错误
1. 检查数据库连接
2. 检查SQL查询语法
3. 检查环境变量

### 前端脚本错误
1. 使用内联脚本
2. 检查控制台错误
3. 清除浏览器缓存

---

## 📝 提交前检查

- [ ] 所有路由已注册
- [ ] 所有环境变量已设置
- [ ] 所有数据库表已创建
- [ ] 本地测试通过
- [ ] 代码已推送到GitHub
- [ ] 部署后测试通过

---

## 🎯 核心原则

1. **小步提交**: 每次只改一个功能，立即测试
2. **立即注册**: 添加路由后立即在server.js中注册
3. **内联优先**: 前端脚本尽量内联，避免外部依赖
4. **错误处理**: 所有数据库查询使用maybeSingle()
5. **测试先行**: 本地测试通过后再部署

